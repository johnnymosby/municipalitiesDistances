---
title: "otp"
author: "Ruslan Basyrov"
date: "7/26/2024"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(gtfstools)
library(tidyverse)
library(rnaturalearth)
```

```{r}
gtfs_path <- file.path("/Users/johnnymosby/repos/thesis_demography/municipalitiesOTPDistances/serverOTP/GTFS")
```

```{r}
gtfs_files <- list.files(path = gtfs_path,
                         pattern = "*.gtfs.zip$",
                         full.names = TRUE)
```

```{r eval=FALSE}
# Reading the GTFS files into a list of R objects
gtfs_merged <- read_gtfs(gtfs_files) |> 
    remove_duplicates()
```


```{r}
# Filter by time of day
gtfs_filtered = read_gtfs(gtfs_files) |> 
    remove_duplicates() |> 
    filter_by_weekday("saturday") |>
    filter_by_time_of_day(from = "18:00:00",
                          to = "20:00:00")
```


```{r eval=FALSE}
{
    filename = paste(gtfs_path, "Austria_2024_saturday_evening_time.gtfs.zip", sep="/")
    write_gtfs(gtfs_filtered,
               filename)
}
```

```{r}
library(sf)
library(stringr)
library(opentripplanner) 

year <- 2022

points <- read_sf(sprintf("/Users/johnnymosby/repos/thesis_demography/municipalitiesOTPDistances/clientR/data/STATISTIK_AUSTRIA_GEM_MP_%s0101/", year),
                    options = "ENCODING=WINDOWS-1252")

points <- st_transform(points, 4326)
points_in_vorarlberg =  points[str_detect(points_in_vorarlberg$g_id, "^8"),]

coordinates <- st_coordinates(points_in_vorarlberg[, "geometry"]) |>
  as.data.frame()

otpcon = otp_connect(hostname = "localhost",
                     router = "default",
                     port = 8080,
                     timezone = "Europe/Vienna")

route <- otp_plan(otpcon, 
                  fromPlace = c(9.899610, 47.09437), 
                  toPlace = c(9.899610, 47.09437))
```


```{r eval=FALSE}
#validator_path = download_validator(gtfs_path)
validator_path = "/Users/johnnymosby/Dropbox/to delete/code testing/graphs/default/gtfs-validator-v4.0.0.jar"
validate_gtfs(gtfs = gtfs_merged,
              output_path = "/Users/johnnymosby/Dropbox/to delete/code testing/graphs/default/",
              validator_path = validator_path)
```

```{r}
{
    austria <- ne_countries(country = "austria", scale = "medium", returnclass = "sf")
    ggplot() +
          geom_sf(data = austria, fill = "lightgreen", color = "black") +
          geom_point(data = gtfs_merged$stops, aes(x = stop_lon, y = stop_lat), color = "red", size = 0.1) +
          coord_sf(xlim = c(9.5, 17.5), ylim = c(46.5, 49.5)) +
          theme_minimal() |> 
        print()
}
```

